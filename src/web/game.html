<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Game Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@500;700&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div>
        <p class="topbar__kicker">Boardgame Studio</p>
        <h1 id="game-title">Game Editor</h1>
      </div>
      <div class="topbar__right">
        <div class="topbar__status" id="status">Ready.</div>
        <div class="topbar__actions">
          <button id="connect-drive" class="button button--ghost">Connect Drive</button>
          <button id="disconnect-drive" class="button button--ghost" hidden>Disconnect</button>
        </div>
      </div>
    </header>

    <main class="shell shell--wide">
      <section class="panel panel--stack">
        <div class="panel-title">
          <div>
            <p class="kicker">Current Game</p>
            <h2 id="current-game">Loading...</h2>
          </div>
          <div class="meta" id="game-meta"></div>
        </div>
        <div class="toolbar">
          <a class="button button--ghost" href="index.html">Back to Games</a>
          <button id="rename-game" class="button button--ghost">Rename Game</button>
          <button id="delete-game" class="button button--danger">Delete Game</button>
          <a id="print-link" class="button button--ghost" href="#" target="_blank" rel="noopener">Print Sheets</a>
        </div>
      </section>

      <!-- Unified Card Editor Section -->
      <section class="content">
        <div class="cards-panel">
          <div class="panel-title">
            <h3>Cards</h3>
            <button id="new-card" class="button button--primary">New Card</button>
          </div>
          <div id="cards-list" class="stack"></div>
        </div>

        <div class="editor-panel">
          <div class="panel-title">
            <div>
              <h3>Card Editor</h3>
              <div class="mode-toggle">
                <button id="mode-card" class="button button--ghost mode-toggle__button is-active">Edit Card Data</button>
                <button id="mode-layout" class="button button--ghost mode-toggle__button">Edit Layout</button>
              </div>
            </div>
            <div class="panel-actions">
              <button id="save-card" class="button button--primary" data-mode="card">Save Card</button>
              <button id="delete-card" class="button button--danger" data-mode="card">Delete Card</button>
              <button id="add-section" class="button button--ghost" data-mode="layout" hidden>Add Section</button>
              <button id="add-item" class="button button--ghost" data-mode="layout" hidden>Add Item</button>
              <button id="save-template" class="button button--primary" data-mode="layout" hidden>Save Layout</button>
            </div>
          </div>

          <div class="editor">
            <div class="editor__controls">
              <!-- Card Data Mode -->
              <div id="card-mode-content">
                <form id="card-form" class="form">
                  <label>
                    <span>Name</span>
                    <input type="text" name="name" required />
                  </label>
                  <div class="meta" id="card-meta">
                    <span>Card ID:</span>
                    <input type="text" id="card-id-input" placeholder="auto-generated" />
                  </div>
                </form>

                <!-- Hidden container for backward compatibility with renderDynamicFields -->
                <div id="dynamic-fields" style="display: none;"></div>

                <div class="field-panel">
                  <p class="kicker">Card Fields</p>
                  <div class="field-badges" id="card-field-badges"></div>
                </div>

                <div class="control-panel" id="card-control-panel">
                  <div class="control-panel__label" id="card-control-label">Select a field to edit.</div>
                  <div class="control-panel__body" id="card-control-body" hidden>
                    <div class="control-text" id="card-control-text">
                      <textarea id="card-control-textarea" rows="3"></textarea>
                    </div>
                    <div class="control-image" id="card-control-image" hidden>
                      <img class="image-field__preview" id="card-image-preview" style="max-width: 100%; max-height: 200px; display: none; margin-top: 8px; border: 1px solid #d7cdbd; border-radius: 8px;" />
                      <input type="text" id="card-image-url" placeholder="Enter image URL or upload a file" style="margin-top: 8px;" />
                      <input type="file" id="card-image-file" accept="image/*" style="display: none;" />
                      <div style="margin-top: 8px;">
                        <button type="button" id="card-image-upload" class="button button--ghost">Upload Image</button>
                        <button type="button" id="card-image-clear" class="button button--ghost" style="margin-left: 8px;">Clear</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Layout Mode -->
              <div id="layout-mode-content" hidden>
                <div class="template__list" id="node-list"></div>
                
                <div class="field-panel">
                  <p class="kicker">Layout Fields</p>
                  <div class="field-badges" id="field-badges"></div>
                </div>

                <div class="control-panel" id="control-panel">
                  <div class="control-panel__label" id="control-label">Select a field to edit.</div>
                  <div class="control-panel__body" id="control-body" hidden>
                    <div class="control-panel__actions" id="control-actions">
                      <button class="button button--ghost" id="move-up">Move Up</button>
                      <button class="button button--ghost" id="move-down">Move Down</button>
                      <button class="button button--danger" id="delete-node">Delete</button>
                    </div>
                    <div class="control-number" id="control-number" hidden>
                      <input id="control-range" type="range" />
                      <div class="control-number__row">
                        <button class="button button--ghost" id="control-dec">-</button>
                        <input id="control-input" type="number" />
                        <button class="button button--ghost" id="control-inc">+</button>
                      </div>
                    </div>
                    <div class="control-select" id="control-select" hidden>
                      <select id="control-select-input"></select>
                    </div>
                    <div class="control-text" id="control-text" hidden>
                      <input id="control-text-input" type="text" />
                    </div>
                    <div class="control-anchor" id="control-anchor" hidden>
                      <div class="anchor-grid" id="control-anchor-grid">
                        <button data-ax="0" data-ay="0"></button>
                        <button data-ax="0.5" data-ay="0"></button>
                        <button data-ax="1" data-ay="0"></button>
                        <button data-ax="0" data-ay="0.5"></button>
                        <button data-ax="0.5" data-ay="0.5"></button>
                        <button data-ax="1" data-ay="0.5"></button>
                        <button data-ax="0" data-ay="1"></button>
                        <button data-ax="0.5" data-ay="1"></button>
                        <button data-ax="1" data-ay="1"></button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="preview">
              <div class="preview__frame">
                <img id="card-preview" src="" alt="Card preview" />
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal for selecting item type -->
    <div id="item-type-modal" class="modal" hidden>
      <div class="modal__overlay"></div>
      <div class="modal__content">
        <h3 class="modal__title">Select Item Type</h3>
        <div class="modal__body">
          <label class="modal__label">
            <span>Item Type:</span>
            <select id="item-type-select" class="modal__select">
              <option value="text">Text</option>
              <option value="frame">Frame</option>
              <option value="image">Image</option>
            </select>
          </label>
        </div>
        <div class="modal__actions">
          <button id="item-type-cancel" class="button button--ghost">Cancel</button>
          <button id="item-type-confirm" class="button button--primary">Add Item</button>
        </div>
      </div>
    </div>

    <script type="module" src="editor.js?v=11"></script>
  </body>
</html>
