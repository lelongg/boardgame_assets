const E={palette:{paper:"#f6f1e9",ink:"#1b1a17",muted:"#5f5a53"},typography:{title:"'Fraunces', serif",body:"'Space Grotesk', sans-serif"}},x=t=>String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"),C="#c65a32",R="2.5",B=.08,G=.15,T=[{x:0,y:0},{x:.5,y:0},{x:1,y:0},{x:0,y:.5},{x:.5,y:.5},{x:1,y:.5},{x:0,y:1},{x:.5,y:1},{x:1,y:1}],H=t=>t==="center"?"middle":t==="right"?"end":"start",U=t=>t.y===0?"hanging":t.y===.5?"middle":"baseline",p=(t,e)=>({x:t.x+t.width*e.x,y:t.y+t.height*e.y}),A=(t,e,o)=>{if(o.sections.set(t.id,e),!t.children.length)return;if(t.layout==="stack"){t.children.forEach($=>A($,e,o));return}const r=Math.max(t.children.length-1,0)*t.gap,a=t.layout==="row"?e.width:e.height,s=t.children.reduce(($,h)=>$+(h.sizePct||0),0)||100;let d=0;t.children.forEach(($,h)=>{const l=($.sizePct||0)/s*(a-r),c=t.layout==="row"?{x:e.x+d,y:e.y,width:l,height:e.height}:{x:e.x,y:e.y+d,width:e.width,height:l};d+=l+(h<t.children.length-1?t.gap:0),A($,c,o)})},P=(t,e,o)=>{t.items.forEach(r=>o.push({item:r,sectionId:t.id})),t.children.forEach(r=>P(r,e,o))},N=(t,e,o)=>{const r=e.width*(t.widthPct/100),a=e.height*(t.heightPct/100),s=p(o,t.attach.anchor);return{x:s.x-r*t.anchor.x,y:s.y-a*t.anchor.y,width:r,height:a}},q=(t,e)=>{const o=[];P(t.root,e,o);const r=new Map;o.forEach(s=>r.set(s.item.id,s));const a=(s,d)=>{const $=e.items.get(s);if($)return $;const h=r.get(s);if(!h||d.has(s))return null;d.add(s);const l=e.sections.get(h.sectionId);if(!l)return d.delete(s),null;let c=null;h.item.attach.targetType==="item"?(c=a(h.item.attach.targetId,d),c||(c=l)):c=e.sections.get(h.item.attach.targetId)??l;const g=N(h.item,l,c);return e.items.set(s,g),d.delete(s),g};o.forEach(s=>{a(s.item.id,new Set)})},z=t=>{const e={sections:new Map,items:new Map},o={x:t.bleed,y:t.bleed,width:t.width-t.bleed*2,height:t.height-t.bleed*2};return A(t.root,o,e),q(t,e),e},O=(t,e)=>{e.push(...t.items),t.children.forEach(o=>O(o,e))},M=(t,e)=>{if(t.id===e)return t;for(const o of t.children){const r=M(o,e);if(r)return r}return null},j=(t,e)=>{const o=t.items.find(r=>r.id===e);if(o)return o;for(const r of t.children){const a=j(r,e);if(a)return a}return null},J=(t,e,o={})=>{const{palette:r,typography:a}=E,{width:s,height:d,radius:$}=e,h=z(e),l=[];O(e.root,l);const c=l.map(n=>{const i=h.items.get(n.id);if(!i)return"";const y=n.type??"text";if(y==="frame"){if(n.type!=="frame")return"";const b=n.strokeWidth??2,k=x(n.strokeColor??r.ink),v=x(n.fillColor??"none"),I=n.cornerRadius??0;return`<rect x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" rx="${I}" fill="${v}" stroke="${k}" stroke-width="${b}" />`}if(y==="image"){if(n.type!=="image")return"";const b=n.fieldId==="name"?t.name:t.fields[n.fieldId]??"";if(!b)return"";const k=n.cornerRadius??0,v=n.fit??"cover",I=`clip-${String(n.id).replace(/[^a-zA-Z0-9-_]/g,"")}`,W=k>0?`<clipPath id="${I}"><rect x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" rx="${k}" /></clipPath>`:"",D=v==="contain"?"xMidYMid meet":v==="fill"?"none":"xMidYMid slice",Y=k>0?` clip-path="url(#${I})"`:"";return`${W}<image x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" href="${x(b)}" preserveAspectRatio="${D}"${Y} />`}if(n.type==="frame"||n.type==="image")return"";const f=n.fieldId==="name"?t.name:t.fields[n.fieldId]??"";if(!f)return"";const u=p(i,n.anchor),S=n.font==="title"?a.title:a.body,L=n.fontSize??20,_=n.align??"left",F=x(n.color??r.ink);return`<text x="${u.x}" y="${u.y}" text-anchor="${H(_)}" dominant-baseline="${U(n.anchor)}" font-family="${S}" font-size="${L}" fill="${F}">${x(f)}</text>`}).join(""),g=o.debug?l.map(n=>{const i=h.items.get(n.id);if(!i)return"";const y=T.map(f=>{const u=p(i,f);return`<circle cx="${u.x}" cy="${u.y}" r="3" fill="${r.muted}" />`}).join("");return`
  <rect x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" rx="10" fill="none" stroke="${r.muted}" stroke-width="1" />
  ${y}`}).join(""):"",w=o.debug?l.map(n=>{const i=h.items.get(n.id);if(!i)return"";const y=n.attach.targetType==="item"?h.items.get(n.attach.targetId):h.sections.get(n.attach.targetId),f=y?p(y,n.attach.anchor):{x:16,y:16},u=p(i,n.anchor),S=y?"":`<text x="${f.x+8}" y="${f.y+4}" font-size="12" fill="#d64545" font-family="${E.typography.body}">missing ${x(n.attach.targetType)}:${x(n.attach.targetId)}</text>`;return`
  <circle cx="${f.x}" cy="${f.y}" r="8" fill="none" stroke="#d64545" stroke-width="3" />
  <circle cx="${u.x}" cy="${u.y}" r="6" fill="#2f6f4e" stroke="#ffffff" stroke-width="1" />
  ${S}`}).join(""):"",m=o.debug?`<text x="24" y="36" font-size="20" fill="#d64545" font-family="${E.typography.body}">DEBUG RENDER</text>`:"";return`<?xml version="1.0" encoding="UTF-8"?>
<svg width="${s}" height="${d}" viewBox="0 0 ${s} ${d}" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="${s}" height="${d}" rx="${$}" fill="${r.paper}" />
  ${m}
  ${g}
  ${w}
  ${c}
</svg>`},K=(t,e=null)=>{const{palette:o}=E,{width:r,height:a,radius:s}=t,d=z(t),$=Array.from(d.sections.entries()).map(([l,c])=>{M(t.root,l);const g=e&&e.type==="section"&&e.id===l,w=g?C:o.muted,m=g?R:"1",n=g?`rgba(198, 90, 50, ${B})`:"none",i=T.map(y=>{const f=p(c,y);return`<circle cx="${f.x}" cy="${f.y}" r="3" fill="${o.muted}" />`}).join("");return`
  <rect x="${c.x}" y="${c.y}" width="${c.width}" height="${c.height}" rx="12" fill="${n}" stroke="${w}" stroke-width="${m}" stroke-dasharray="6 6" />
  ${i}`}).join(""),h=Array.from(d.items.entries()).map(([l,c])=>{j(t.root,l);const g=e&&e.type==="item"&&e.id===l,w=g?C:o.ink,m=g?R:"1",n=g?`rgba(198, 90, 50, ${G})`:"none",i=T.map(y=>{const f=p(c,y);return`<circle cx="${f.x}" cy="${f.y}" r="2.5" fill="${o.ink}" />`}).join("");return`
  <rect x="${c.x}" y="${c.y}" width="${c.width}" height="${c.height}" rx="10" fill="${n}" stroke="${w}" stroke-width="${m}" />
  ${i}`}).join("");return`<?xml version="1.0" encoding="UTF-8"?>
<svg width="${r}" height="${a}" viewBox="0 0 ${r} ${a}" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="${r}" height="${a}" rx="${s}" fill="${o.paper}" />
  ${$}
  ${h}
</svg>`},Z=(t,e)=>{const r=`<text x="24" y="70" font-size="12" fill="#d64545" font-family="Space Grotesk, sans-serif">${`ATTACH ${JSON.stringify(e)}`.replaceAll("<","&lt;").replaceAll(">","&gt;")}</text>`;return t.replace("</svg>",`${r}</svg>`)};export{Z as injectDebugLabel,J as renderCardSvg,K as renderTemplateSvg};
